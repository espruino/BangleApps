<html>
  <head>
    <link rel="stylesheet" href="../../css/spectre.min.css">
    <style>
      #errors {
        overflow: scroll;
      }
    </style>
  </head>
  <body>
    <script src="../../core/lib/customize.js"></script>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

    <!-- Toggle Buttons -->
    <div class="btn-group" style="margin: 1em; display: flex; justify-content: center;">
      <button id="tableButton" class="btn btn-primary">View Table</button>
      <button id="pieChartButton" class="btn">View Pie Chart</button>
    </div>

    <!-- Table View -->
    <div id="storageTable"></div>

    <!-- Chart View -->
    <div id="storagePieChart" style="display: none; flex-direction: column; align-items: center;">
      <div id="piechart" style="width: 100%; max-width: 600px; height: 400px;"></div>
      <div id="totalStoragePie" style="width: 100%; max-width: 600px; height: 300px;"></div>
    </div>

    <pre id="errors"></pre>

    <script>
      let globalApps = [];
      let storageStats = null;

      async function onInit(device) {
        const puckRequest = js => new Promise(resolve => Puck.eval(js, resolve));
        const wildcardToRegexp = wc => new RegExp("^" + wc.replaceAll(".", "\\.").replaceAll("?", ".*") + "$");
        const fileSize = async f => await puckRequest(`(require("Storage").read("${f}") || "").length`);
        const sum = (a, b) => a + b;

        Util.showModal("Reading Storage...");

        const apps = [];
        let stats;
        const errors = [];
        try{
          stats = await puckRequest('require("Storage").getStats()');

          const infos = await puckRequest('require("Storage").list(/\\.info$/)');

          for(const appInfoName of infos){
            try{
              const appInfo = await puckRequest(`require("Storage").readJSON("${appInfoName}", 1)`);

              if(appInfo == null){
                errors.push({ app: appInfoName, err: "no info file" });
                continue;
              }

              let fileTotal = 0;

              if(appInfo.files){
                for(const f of appInfo.files.split(",")){
                  fileTotal += await fileSize(f);
                }
              }

              let dataSize = 0;

              if(appInfo.data){
                const sumFiles = async (patterns, options) => (
                  (await Promise.all(
                    patterns
                    .map(async pattern => {
                      const names = await puckRequest(`require("Storage").list(${wildcardToRegexp(pattern)}, ${JSON.stringify(options)})`);

                      return (await Promise.all(names.map(fileSize))).reduce(sum, 0)
                    })
                  ))
                  .reduce(sum, 0)
                );

                /* parse the datastring, see core/js/appinfo.js, makeDataString */
                const fileObj = appInfo.data.split(";").map(d => d.split(","));
                const files = fileObj[0];
                const storage = fileObj[1];
                if (files == null || (files.length === 1 && files[0] === "")) files = [];

                dataSize = await sumFiles(files, {sf: false}) + await sumFiles(storage || [], {sf: true});
              }

              apps.push({ id: appInfo.id, fileSize: fileTotal, dataSize });
            }catch(e){
              errors.push({ app: appInfoName, err: "" + e });
            }
          }
        }finally{
          Util.hideModal();
        }

        globalApps = apps.sort((a,b) => (b.fileSize + b.dataSize) - (a.fileSize + a.dataSize));
        storageStats = stats;

        if(errors.length){
          document.getElementById("errors").innerText = errors
            .map(({ app, err }) => `Error in app "${app}": ${err}`)
            .join("\n");
        }

        if (globalApps.length === 0) {
          document.getElementById("storageTable").innerHTML = "<p>No apps found</p>";
          return;
        }

        drawTable();
      }
      function roundDecimal(num){
        return Math.round(num * 10) / 10;
      }
      function drawTable() {
        document.getElementById("storageTable").innerHTML = `
          <table class="table table-striped">
            <thead>
              <tr>
                <th>App</th>
                <th>Code (kb)</th>
                <th>Data (kb)</th>
                <th>Total (kb)</th>
              </tr>
            </thead>
            <tbody>
              ${globalApps.map(app => `
                <tr>
                  <td>${app.id}</td>
                  <td>${(app.fileSize/1000).toFixed(1)}</td>
                  <td>${(app.dataSize/1000).toFixed(1)}</td>
                  <td>${((app.fileSize+app.dataSize)/1000).toFixed(1)}</td>
                </tr>`).join("")}
            </tbody>
          </table>`;
      }

      function drawChart() {
        if (globalApps.length === 0) return;

        // App-specific chart
        const chartData = [
          ['App', 'Total Size (KB)']
        ].concat(globalApps.map(app => [app.id, roundDecimal((app.fileSize + app.dataSize)/1000)]));

        const data = google.visualization.arrayToDataTable(chartData);

        const options = {
          title: 'App Storage Breakdown (KBs)',
          chartArea: { width: '90%', height: '80%' },
          legend: { position: 'bottom' }
        };

        const chart = new google.visualization.PieChart(document.getElementById('piechart'));
        chart.draw(data, options);

        // Total storage chart
        if (storageStats) {
          const usedKB = roundDecimal(storageStats.fileBytes / 1000);
          const freeKB = roundDecimal(storageStats.freeBytes / 1000);
          const trashKB =  roundDecimal(storageStats.trashBytes / 1000);
          const totalData = google.visualization.arrayToDataTable([
            ['Type', 'KB'],
            ['Used', usedKB],
            ['Free', freeKB],
            ['Trash', trashKB],
          ]);

          const totalOptions = {
            title: 'Total Storage Usage (KBs)',

            chartArea: { width: '90%', height: '80%' },
            legend: { position: 'bottom' }
          };

          const totalChart = new google.visualization.PieChart(document.getElementById('totalStoragePie'));
          totalChart.draw(totalData, totalOptions);
        }
      }

      google.charts.load('current', {'packages':['corechart']});


      document.getElementById("pieChartButton").addEventListener("click", function () {
        document.getElementById("storageTable").style.display = "none";
        document.getElementById("storagePieChart").style.display = "flex";
        drawChart();
        this.classList.add("btn-primary");
        document.getElementById("tableButton").classList.remove("btn-primary");
      });

      document.getElementById("tableButton").addEventListener("click", function () {
        document.getElementById("storageTable").style.display = "block";
        document.getElementById("storagePieChart").style.display = "none";
        drawTable();
        this.classList.add("btn-primary");
        document.getElementById("pieChartButton").classList.remove("btn-primary");
      });

    </script>
  </body>
</html>
