<html>
  <head>
    <link rel="stylesheet" href="../../css/spectre.min.css">
  </head>
  <body>

    <h4>Products</h4>
    <form id="add_product_form">
      <div class="columns">
        <textarea id="area" class="form-input" style="width: 80%;margin-left: 2%;margin-bottom: 5%;height: 150px;"></textarea>
        <div id="loadingstatus" style="display:none;margin-left:2%;">Processing image <div class="loading" id="loading"></div></div>
        <input style="margin-left:2%;" id="upload2" type=file name="files[]" size=30>
      </div>
    </form>
    <br><br>
   <button id="upload" class="btn btn-primary">Upload</button>

    <script src="../../core/lib/customize.js"></script>

    <script>
   if(!localStorage.getItem('apikey')) {
     
     var ak = prompt('Enter API key:','');
     if(ak!="") {
      localStorage.setItem('apikey', ak);
     }
   
   }
   var apikey = localStorage.getItem('apikey');
  
   var antwort_val="";
    function handleFileSelect(evt) {
        
        document.getElementById("loadingstatus").style.display = "block";

        let files = evt.target.files;
        let f = files[0];
        const data = new FormData();
        data.append("srcImg", f);
        data.append("Session", "string");

        const xhr = new XMLHttpRequest();
        xhr.withCredentials = false;

        xhr.addEventListener("readystatechange", function () {
          if (this.readyState === this.DONE) {
            document.getElementById("loadingstatus").style.display = "none";
            console.log(this.responseText);
            var antwort =JSON.parse(this.responseText);
            antwort_val = antwort["value"];
            document.getElementById('area').value = antwort_val;
          }
        });

        xhr.open("POST", "https://pen-to-print-handwriting-ocr.p.rapidapi.com/recognize/");
        xhr.setRequestHeader("x-rapidapi-host", "pen-to-print-handwriting-ocr.p.rapidapi.com");
        xhr.setRequestHeader("x-rapidapi-key", apikey);


          xhr.send(data);
      }
      
      document.getElementById('upload2').addEventListener('change', handleFileSelect, false);

      var products = []
     try{
        var stored = localStorage.getItem('grocery-product-list-aug')
        if(stored){
          products = JSON.parse(stored);
          console.log(products);
        }
       
      }catch(e){}
      
      var tstring = "";
      for(e in products) {
        tstring += products[e]["name"]+"\n";
      }
      document.getElementById("area").value = tstring;


      var $form = document.getElementById('add_product_form')
      var $list = document.getElementById('products')
      var $area = document.getElementById("area");             
      var $lines = [];
      function getLines() {
        $lines = area.value.replace(/\r\n/g,"\n").split("\n");
        for (var i in $lines) {
          $lines[i] = $lines[i].trim();
        }
      }
      getLines();


      function save(){
        localStorage.removeItem('grocery-product-list-aug');
        localStorage.setItem('grocery-product-list-aug',JSON.stringify(products));
      }



      document.getElementById("upload").addEventListener("click", function() {
        
        products = [];
        getLines();
        for(var i in $lines) {
          var name = $lines[i];
          products.push({
            name,
            ok: false
          })
        }
          //alert("Products added");

        save()
        
        sendCustomizedApp({
          storage:[
            { name:"grocery_list_aug.json", content: JSON.stringify({products: products}) }
          ]
        });
      });
    </script>
  </body>
</html>
