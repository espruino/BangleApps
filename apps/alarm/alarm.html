<html>
  <head>
    <link rel="stylesheet" href="../../css/spectre.min.css">
  </head>
  <body>

    <p><button id="fetch" class="btn btn-primary">Fetch Language from Bangle.js</button></p>
    <p>Then please choose a language from the following list:</p>
    <div class="form-group">
    <select id="languages" class="form-select">
    </select>
    </div>
    <p>Then click <button id="upload" class="btn btn-primary">Upload</button></p>

    <script src="../../lib/customize.js"></script>
    <script src="https://www.puck-js.com/puck.js"></script>

    <script>
      let request = url => {
          return new Promise((resolve, reject) => {
              let xhr = new XMLHttpRequest();
              xhr.open("GET", url);
              xhr.onload = () => {
                  if (xhr.status >= 200 && xhr.status < 300) {
                      resolve(xhr.response);
                  } else {
                      reject(xhr.statusText);
                  }
              };
              xhr.onerror = () => reject(xhr.statusText);
              xhr.send(obj.body);
          });
      };    
      
      document.getElementById("fetch").addEventListener("click", function() {
        new Promise((resolve,reject) => {
          Puck.write("\x03",(result) => {
            if (result===null) return reject("");
            Puck.eval(`require("locale").lang`, (content,err) => {
              if (content===null) return reject(err || "");
              resolve(content);
            });
          });
        }).catch( error => {
          console.log("Error getting langFromDevice, using fallback en_GB, error was: " + error);
          return "en_GB";
        }).then( lang => {
          var languageSelector = document.getElementById("languages");
          languageSelector.innerHTML = ["en_GB","de_DE","fr_FR","en_US","en_JP","nl_NL","en_CA","sv_SE","en_AU","de_AT","en_IL","es_ES","fr_BE","fi_FI","de_CH","fr_CH","it_CH","tr_TR","hu_HU"].map(l=>`<option value="${l}"${(l===lang)?" selected":""})>${l}</option>`).join("\n");
        });
      });
      

      document.getElementById("upload").addEventListener("click", function() {
        var lang = languageSelector.options[languageSelector.selectedIndex].value;
        console.log(lang);      
        request("app.js").then( appjs => { 
          request("app_" + lang + ".json").catch( () => request("app_" + lang.subsring(0,2) + ".json")).then( langjson => {
            var trans = JSON.parse(langjson);
            appjs = appjs.replace(/"(.*?)"\/\*LANG\*\//g, function(m, p1) { return '"' + (trans[p1]||p1) + '"'; });
            appjs = appjs.replace(/'(.*?)'\/\*LANG\*\//g, function(m, p1) { return '"' + (trans[p1]||p1) + '"'; });
            return appjs;
          }).catch( error => {
            console.log(error);
            return appjs; // unmodified app.js
          }).then( appjs => {
            console.log("app.js is:", appjs);
            sendCustomizedApp({
              storage:[
                {"name":"alarm.app.js",content: appjs},
                {"name":"alarm.boot.js","url":"boot.js"},
                {"name": "alarm.js", "url":"alarm.js"},
                {"name":"alarm.json","content":"[]"},
                {"name":"alarm.img","url":"app-icon.js","evaluate":true},
                {"name":"alarm.wid.js","url":"widget.js"}                
              ]
            });          
          });
        }).catch( error => {
          console.log(error);
        });
      });
    </script>
  </body>
</html>        
