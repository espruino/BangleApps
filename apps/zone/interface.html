<!DOCTYPE html>
<html>
<head>
    <title>Google Maps Circle and Geofencing Example</title>
    <style>
        /* Set the size of the map */
        #map {
            height: 100vh;
            width: 100%;
            position: relative;
            z-index: 1;
        }
        body {
            padding: 0;
            margin: 0;
            height: 100%;
            width: 100%;
            display: flex;
            flex-direction: column;
        }
        #controls {
            padding: 10px;
            border: 1px solid black;
            position: absolute;
            right: 10px;
            top: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            z-index: 100;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        #controls label {
            display: inline-block;
            margin-right: 5px;
        }
        #controls input {
            width: 60px;
            margin-right: 5px;
        }
        #controls button {
            display: block;
            margin-top: 10px;
            width: 100%;
        }
        #maptiles {
            display: none;
        }
        #uploadbuttons {
            display: none;
            position: absolute;
            bottom: 10px;
            right: 10px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div id="controls">
        <div class="form-group">
            <label for="radius">Radius (m):</label>
            <input type="number" id="radius" value="50">
        </div>
        <button id="updateCircle" class="btn btn-primary">Update Circle</button>
        <button id="getmap" class="btn btn-primary">Get Map</button>
    </div>
    <div id="uploadbuttons">
        <button id="upload" class="btn btn-primary">Upload</button>
        <button id="cancel" class="btn">Cancel</button>
        <span id="mapstats"></span>
    </div>
    <canvas id="maptiles"></canvas>

    <script>
        let map, circle;

        function initMap() {
            // Create a map centered at a specific location
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: 21.331115, lng: 39.946196 },
                zoom: 19,
            });

            // Create a circle overlay on the map
            circle = new google.maps.Circle({
                strokeColor: "#FF0000",
                strokeOpacity: 0.8,
                strokeWeight: 2,
                fillColor: "#FF0000",
                fillOpacity: 0.35,
                map,
                center: { lat: 21.331115, lng: 39.946196 },
                radius: parseFloat(document.getElementById("radius").value), // 50 meters radius
            });

            // Check user's position when the page loads
            checkPosition(circle);

            // Watch user's position continuously
            navigator.geolocation.watchPosition((position) => {
                const userLatLng = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                // Check if user is outside the circle
                if (!google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(userLatLng), circle.getCenter()) <= circle.getRadius()) {
                    alert("You are outside the geofenced area!");
                }
            }, (error) => {
                console.error(error);
            }, {
                enableHighAccuracy: true
            });
        }

        function checkPosition(circle) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition((position) => {
                    const userLatLng = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };

                    // Check if user is outside the circle
                    if (!google.maps.geometry.spherical.computeDistanceBetween(new google.maps.LatLng(userLatLng), circle.getCenter()) <= circle.getRadius()) {
                        alert("You are outside the geofenced area!");
                    }
                }, (error) => {
                    console.error(error);
                }, {
                    enableHighAccuracy: true
                });
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        document.getElementById("updateCircle").addEventListener("click", () => {
            const newRadius = parseFloat(document.getElementById("radius").value);
            circle.setRadius(newRadius);
        });

        document.getElementById("getmap").addEventListener("click", () => {
            getMapTiles();
        });

        document.getElementById("upload").addEventListener("click", () => {
            uploadToBangle();
        });

        document.getElementById("cancel").addEventListener("click", () => {
            document.getElementById("uploadbuttons").style.display = "none";
            document.getElementById("maptiles").style.display = "none";
        });

        function getMapTiles() {
            const TILESIZE = 96; // Size of our tiles
            const OSMTILESIZE = 256; // Size of openstreetmap tiles
            const MAPTILES = 5; // Number of tiles
            const MAPSIZE = TILESIZE * MAPTILES; // Size of map we download to Bangle in pixels

            const canvas = document.getElementById("maptiles");
            canvas.width = MAPSIZE;
            canvas.height = MAPSIZE;
            const ctx = canvas.getContext('2d');

            const zoom = map.getZoom();
            const center = map.getCenter();

            const bounds = map.getBounds();
            const topLeft = new google.maps.LatLng(bounds.getNorthEast().lat(), bounds.getSouthWest().lng());
            const bottomRight = new google.maps.LatLng(bounds.getSouthWest().lat(), bounds.getNorthEast().lng());

            const getTileUrl = (coord, zoom) => {
                return `https://mt1.google.com/vt/lyrs=m&x=${coord.x}&y=${coord.y}&z=${zoom}`;
            };

            const tileCoord = (latLng, zoom) => {
                const scale = 1 << zoom;
                const worldCoordinate = map.getProjection().fromLatLngToPoint(latLng);
                const pixelCoordinate = new google.maps.Point(worldCoordinate.x * scale, worldCoordinate.y * scale);
                const tileCoordinate = new google.maps.Point(
                    Math.floor(pixelCoordinate.x / OSMTILESIZE),
                    Math.floor(pixelCoordinate.y / OSMTILESIZE)
                );
                return tileCoordinate;
            };

            const topLeftTile = tileCoord(topLeft, zoom);
            const bottomRightTile = tileCoord(bottomRight, zoom);

            const promises = [];

            for (let y = topLeftTile.y; y <= bottomRightTile.y; y++) {
                for (let x = topLeftTile.x; x <= bottomRightTile.x; x++) {
                    promises.push(new Promise((resolve, reject) => {
                        const img = new Image();
                        img.crossOrigin = "Anonymous";
                        img.src = getTileUrl({ x, y }, zoom);
                        img.onload = () => {
                            ctx.drawImage(img, (x - topLeftTile.x) * OSMTILESIZE, (y - topLeftTile.y) * OSMTILESIZE);
                            resolve();
                        };
                        img.onerror = reject;
                    }));
                }
            }

            Promise.all(promises).then(() => {
                document.getElementById("uploadbuttons").style.display = "block";
                document.getElementById("maptiles").style.display = "block";
            }).catch((err) => {
                console.error("Error loading map tiles", err);
            });
        }

        function uploadToBangle() {
            // Implement the upload functionality here
            const canvas = document.getElementById("maptiles");
            const imageData = canvas.toDataURL("image/png");
            console.log("Map image data:", imageData);

            // For actual uploading to Bangle.js 2, implement the necessary communication
            // protocol, probably using the Espruino Web IDE or other methods.
            alert("Upload functionality is not implemented in this example.");
        }

        // Load the Google Maps script dynamically
        function loadScript() {
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=AIzaSyCCeZg-o1jX4x1wjuKVdngEkFWHDBVn-I0&libraries=geometry&callback=initMap`;
            script.defer = true;
            script.async = true;
            document.head.appendChild(script);
        }

        // Call the loadScript function when the window loads
        window.onload = loadScript;
    </script>
</body>
</html>
